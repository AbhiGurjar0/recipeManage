<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>recipe Details</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
    <link as="style"
        href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Work+Sans%3Awght%40400%3B500%3B700%3B900"
        onload="this.rel='stylesheet'" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>
<style type="text/tailwindcss">
    :root {
        --primary-color: #f2780d;
        --secondary-color: #f5f2f0;
        --text-primary: #181411;
        --text-secondary: #8a7460;
        --background-color: #ffffff;
      }
      .material-symbols-outlined {
        font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
      }
    </style>

<body>
    <div class="w-full h-[10vh]">
        <%- include('partials/navbar') %>
    </div>
    <div class="flex flex-col md:flex-row gap-6 md:px-32 pt-10 mb-10 border-b-2 px-10 overflow-hidden">
        <!-- Left Section: Thumbnails -->

        <div class="hidden md:block md:w-[5vw] space-y-4">
            <% product.images.forEach(function(image, index) { %>
                <img src="data:image/jpeg;base64,<%= image.toString('base64') %>" alt="Product Image"
                    class="w-full rounded-lg cursor-pointer border hover:scale-105 transition"
                    onclick="changeImage('<%= index %>')" />
                <% }) %>
        </div>

        <!-- Main Image -->
        <div class="w-full h-[50vh] md:w-[35vw] md:h-[40vw] flex justify-center items-center relative">
            <% if (product.images && product.images.length> 0) { %>
                <img id="mainImage" src="data:image/jpeg;base64,<%= product.images[0].toString('base64') %>"
                    alt="Product Image"
                    class="w-full h-[40vh] md:w-[35vw] md:h-[40vw] object-cover object-center rounded-xl shadow-lg" />
                <% } else { %>
                    <p>No images available for this product.</p>
                    <% } %>
        </div>

        <!-- Right Section -->
        <div class="w-full md:w-1/3 space-y-4 md:p-0">
            <h1 class="capitalize text-3xl font-bold">
                <%=product.name%>
            </h1>

            <!-- Average rating (display only) -->
            <div class="flex items-center space-x-2">
                <div class="flex text-yellow-400 text-lg">
                    <% for (let i=0; i < 5; i++) { %>
                        <% if (i < product.avgRating) { %>
                            ‚òÖ
                            <% } else { %>
                                ‚òÜ
                                <% } %>
                                    <% } %>
                </div>
                <span class="text-sm text-gray-600">(<%= product?.reviews?.length %> reviews)</span>
            </div>

            <div class="text-3xl font-bold text-black">
                ‚Çπ<%=product.price%>
            </div>

            <p class="text-sm text-gray-500 bg-gray-100 p-2 rounded-md">üéâ Offer: 50% Off On Labour</p>

            <!-- Buttons Section -->

            <div class="flex flex-col gap-3 pt-4">


                <!-- Favorite Button -->
                <% if(isFavorite){%>
                    <button id="fav" onclick="addToFavorite(this,'<%=product._id%>')"
                        class="w-full flex items-center justify-center gap-2 bg-yellow-100 text-yellow-600 py-2 px-3 rounded-lg hover:bg-yellow-200 transition">
                        ‚ù§Ô∏è Remove From Favorites
                    </button>
                    <% } else { %>

                        <button id="fav" onclick="addToFavorite(this,'<%=product._id%>')"
                            class="w-full flex items-center justify-center gap-2 bg-pink-100 text-pink-600 py-2 px-3 rounded-lg hover:bg-pink-200 transition">
                            ‚ù§Ô∏è Add to Favorites
                        </button>
                        <% } %>

                            <!-- Add Review -->
                            <button onclick="openReviewModal()"
                                class="w-full flex items-center justify-center gap-2 bg-green-100 text-green-600 py-2 px-3 rounded-lg hover:bg-green-200 transition">
                                ‚úçÔ∏è Add Review
                            </button>
            </div>
           <% if(!existInCollections){%>

            <button onclick="AddToCollections(this,'<%=product._id%>')"
                class="w-full  rounded bg-zinc-100 rounded px-2 py-2">Add to
                collection</button>

           <%}%>

        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <div class="bg-white rounded-lg shadow-lg w-96 p-6">
            <h2 class="text-xl font-bold mb-4">Write a Review</h2>
            <form action="/recipe/<%=product._id%>/review" method="POST">

                <!-- Rating stars -->
                <div class="flex justify-center mb-4 text-2xl text-gray-400 cursor-pointer" id="ratingStars">
                    <span data-value="1">‚òÜ</span>
                    <span data-value="2">‚òÜ</span>
                    <span data-value="3">‚òÜ</span>
                    <span data-value="4">‚òÜ</span>
                    <span data-value="5">‚òÜ</span>
                </div>
                <input type="hidden" name="rating" id="ratingInput" value="0">

                <!-- Review text -->
                <textarea name="review" rows="4" placeholder="Share your thoughts..."
                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>

                <div class="flex justify-end mt-4 gap-3">
                    <button type="button" onclick="closeReviewModal()"
                        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Submit</button>
                </div>
            </form>
        </div>
    </div>




    <!-- Product Description  -->
    <div class="w-full md:w-[90vw] flex flex-col justify-center md:pl-20 gap-10 mb-10 px-10">
        <h2 class="text-2xl font-semibold uppercase mb-2">Product Description</h2>
        <p class="text-lg text-gray-800 leading-relaxed">
            <%=product.description%>
        </p>
    </div>
    <div class="max-w-2xl mx-10 p-6 ">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Customer Reviews</h2>

        <%review?.forEach((rev)=>{%>


            <!-- Review list container -->
            <div id="reviews" class="space-y-5">
                <!-- Example Review -->
                <div class="border border-gray-200 rounded-xl p-4 flex flex-col sm:flex-row sm:items-start gap-4">
                    <img src="https://i.pravatar.cc/60" alt="user" class="w-12 h-12 rounded-full object-cover" />
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-gray-800">
                                <%= rev.user?.name || 'Anonymous' %>
                            </h4>

                        </div>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="text-yellow-400">
                                <% for (let i=1; i <=5; i++) { %>
                                    <%= i <=rev.rating ? '‚òÖ' : '‚òÜ' %>
                                        <% } %>
                            </span>
                            <span class="text-gray-500 text-sm ml-2">
                                <%= rev.rating %>.0
                            </span>
                        </div>
                        <p class="mt-2 text-gray-700 text-sm">
                            <%= rev?.comment%>
                        </p>
                    </div>
                </div>
                <% })%>


            </div>
    </div>
    <div class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 hidden" id="CollectionForm">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4 text-primary-700">Add to Collection</h3>
            <div id="AllCollections" class="flex flex-col gap-2">
                <!-- Collection items will be appended here -->
            </div>
            <button onclick="document.getElementById('CollectionForm').classList.add('hidden')"
                class="mt-6 w-full py-2 rounded-lg bg-primary-600 text-black font-semibold hover:bg-primary-700 transition">
                Close
            </button>
        </div>
    </div>


    <script>
        const images = product.images.map((image) => {
            return `data:image/jpeg;base64,${image.toString('base64')}`;
        });


        function changeImage(index) {
            const mainImage = document.getElementById('mainImage');
            mainImage.src = images[index];
        }

        function openReviewModal() {
            document.getElementById('reviewModal').classList.remove('hidden');
        }
        function closeReviewModal() {
            document.getElementById('reviewModal').classList.add('hidden');
        }

        // Handle star rating
        const stars = document.querySelectorAll('#ratingStars span');
        const ratingInput = document.getElementById('ratingInput');

        stars.forEach(star => {
            star.addEventListener('click', () => {
                let value = star.getAttribute('data-value');
                ratingInput.value = value;

                stars.forEach(s => {
                    s.textContent = s.getAttribute('data-value') <= value ? '‚òÖ' : '‚òÜ';
                    s.classList.toggle('text-yellow-400', s.getAttribute('data-value') <= value);
                    s.classList.toggle('text-gray-400', s.getAttribute('data-value') > value);
                });
            });
        });


        async function addToFavorite(element, Id) {
            let res = await fetch('/user/addFav', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Id })
            })
            console.log(element)
            res = await res.json();
            if (res.success) {
                console.log(res.message);
                element.innerHTML = "";
                element.innerHTML = `
                     ‚ù§Ô∏è Remove From Favorites
                `
            }
            else {
                element.innerHTML = "";
                element.innerHTML = `
                  ‚ù§Ô∏è Add to Favorites
                `
            }


        }

        //add to collections

        async function AddToCollections(element, Id) {
            let form = document.getElementById("CollectionForm");
            let Collection = document.getElementById('AllCollections');

            let response = await fetch("/recipe/AllCollections", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            let data = await response.json();
            Collection.innerHTML = '';
            data.Collection.forEach((col) => {
                let span = document.createElement('span');
                span.textContent = col.name || "Unnamed Collection"; // optional
                span.setAttribute("collectionId", col._id);
                span.setAttribute("recipeId", Id);
                span.className = "cursor-pointer px-4 py-2 bg-zinc-100 rounded-lg  text-primary-700 font-medium hover:bg-primary-200 transition-colors";
                span.addEventListener("click", () => AddToCol(span));
                Collection.appendChild(span);
            });

            form.classList.remove('hidden');

        }
        async function AddToCol(element) {
            let form = document.getElementById("CollectionForm");
            let recipeId = element.getAttribute("recipeId");
            let collectionId = element.getAttribute("collectionId");

            try {
                let response = await fetch("/recipe/AddToCollections", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipeId, collectionId })
                });

                let result = await response.json();
                form.classList.add('hidden');

                if (!response.ok) {
                    console.error("Failed to add recipe:", result.error);
                } else {
                    console.log(result.message);
                }
            } catch (err) {
                console.error("Fetch error:", err);
            }




        }



    </script>

</body>

</html>